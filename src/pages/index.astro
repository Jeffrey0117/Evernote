---
import BaseLayout from '../layouts/BaseLayout.astro';

// 取得所有 markdown 文章
const posts = await Astro.glob('./posts/*.md');

// 按日期排序（新的在前），置頂文章優先
const sortedPosts = posts.sort((a, b) => {
  // 置頂優先
  if (a.frontmatter.pinned && !b.frontmatter.pinned) return -1;
  if (!a.frontmatter.pinned && b.frontmatter.pinned) return 1;
  // 再按日期排序
  return new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime();
});

// 收集所有 tags
const allTags = [...new Set(sortedPosts.flatMap(post => post.frontmatter.tags || []))];

const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  const datePart = date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).replace(/\//g, '.');
  const timePart = date.toLocaleTimeString('zh-TW', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  });
  return `${datePart} ${timePart}`;
};
---

<BaseLayout title="Jeffrey0117 技術筆記">
  <section>
    <div class="tag-filter">
      <button class="filter-btn active" data-tag="all">全部</button>
      {allTags.map((tag) => (
        <button class="filter-btn" data-tag={tag}>{tag}</button>
      ))}
    </div>
    <ul class="post-list">
      {sortedPosts.map((post) => (
        <li class="post-item" data-tags={JSON.stringify(post.frontmatter.tags || [])}>
          <time class="post-date" datetime={post.frontmatter.date}>
            {formatDate(post.frontmatter.date)}
          </time>
          <h2 class="post-title">
            {post.frontmatter.pinned && <span class="pinned-badge">置頂</span>}
            <a href={post.url}>{post.frontmatter.title}</a>
          </h2>
          {post.frontmatter.description && (
            <p class="post-excerpt">{post.frontmatter.description}</p>
          )}
          {post.frontmatter.tags && post.frontmatter.tags.length > 0 && (
            <div class="post-tags">
              {post.frontmatter.tags.map((tag: string) => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          )}
        </li>
      ))}
    </ul>
  </section>
</BaseLayout>

<script>
  const filterBtns = document.querySelectorAll('.filter-btn');
  const postItems = document.querySelectorAll('.post-item');

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const tag = btn.getAttribute('data-tag');

      // 更新 active 狀態
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // 過濾文章
      postItems.forEach(item => {
        if (tag === 'all') {
          item.style.display = '';
        } else {
          const tags = JSON.parse(item.getAttribute('data-tags') || '[]');
          item.style.display = tags.includes(tag) ? '' : 'none';
        }
      });
    });
  });
</script>
