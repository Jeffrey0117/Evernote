---
import BaseLayout from '../layouts/BaseLayout.astro';

// 取得所有 markdown 文章
const posts = await Astro.glob('./posts/*.md');

// 按日期排序（新的在前），置頂文章優先
const sortedPosts = posts.sort((a, b) => {
  // 置頂優先
  if (a.frontmatter.pinned && !b.frontmatter.pinned) return -1;
  if (!a.frontmatter.pinned && b.frontmatter.pinned) return 1;
  // 再按日期排序
  return new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime();
});

// 主分類定義
const categories = {
  '全部': [],
  '技術': ['Electron', 'React', 'Python', 'Node.js', 'CSS', 'TypeScript', 'Astro', 'OpenCV', 'Tesseract.js', 'JSZip', 'AI', 'OCR', '前端', '設計系統'],
  '觀念': ['開發觀念', '專案管理', '寫作', '技術分享', 'Vibe Coding', '工作流程'],
  '專案': ['專案心得', '專案文件'],
  '工具': ['CLI', 'VSCode', '開發工具', 'DX', 'Windows', '自動化'],
};

// 收集所有 tags
const allTags = [...new Set(sortedPosts.flatMap(post => post.frontmatter.tags || []))];

const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  const datePart = date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).replace(/\//g, '.');
  const timePart = date.toLocaleTimeString('zh-TW', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  });
  return `${datePart} ${timePart}`;
};

// 最近 5 篇文章（給側邊欄用）
const recentPosts = sortedPosts.filter(p => !p.frontmatter.pinned).slice(0, 5);

// 統計
const totalPosts = sortedPosts.length;
const totalWords = sortedPosts.reduce((sum, post) => {
  const content = post.rawContent?.() || '';
  return sum + content.length;
}, 0);

// 荒謬比喻
const jokes = [
  `比太陽系的行星多 ${Math.round(totalWords / 8).toLocaleString()} 倍`,
  `大概要 ${Math.round(totalWords / 400 / 60 * 10) / 10} 小時才看得完`,
  `是你 ${Math.round(totalWords / 20000)} 天的呼吸次數`,
  `可以印 ${Math.round(totalWords / 500)} 張 A4 紙`,
];
const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
---

<BaseLayout title="Jeffrey0117 技術筆記">
  <div class="home-layout">
    <section class="main-content">
      <!-- 主分類 -->
      <div class="category-filter">
        {Object.keys(categories).map((cat) => (
          <button class={`category-btn ${cat === '全部' ? 'active' : ''}`} data-category={cat}>
            {cat}
          </button>
        ))}
      </div>

      <!-- 文章列表 -->
      <ul class="post-list">
        {sortedPosts.map((post) => (
          <li class="post-item" data-tags={JSON.stringify(post.frontmatter.tags || [])}>
            <time class="post-date" datetime={post.frontmatter.date}>
              {formatDate(post.frontmatter.date)}
            </time>
            <h2 class="post-title">
              {post.frontmatter.pinned && <span class="pinned-badge">置頂</span>}
              <a href={post.url}>{post.frontmatter.title}</a>
            </h2>
            {post.frontmatter.description && (
              <p class="post-excerpt">{post.frontmatter.description}</p>
            )}
            {post.frontmatter.tags && post.frontmatter.tags.length > 0 && (
              <div class="post-tags">
                {post.frontmatter.tags.map((tag: string) => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
            )}
          </li>
        ))}
      </ul>

      <!-- 所有標籤（底部） -->
      <div class="all-tags-section">
        <button class="tags-toggle">
          <span>所有標籤</span>
          <span class="toggle-icon">▼</span>
        </button>
        <div class="all-tags collapsed">
          {allTags.map((tag) => (
            <button class="filter-btn" data-tag={tag}>{tag}</button>
          ))}
        </div>
      </div>
    </section>

    <!-- 側邊欄 -->
    <aside class="sidebar">
      <div class="sidebar-stats">
        <p>這裡有 {totalPosts} 篇文章</p>
        <p>共 {totalWords.toLocaleString()} 字</p>
        <p class="stats-joke">{randomJoke}</p>
      </div>

      <div class="sidebar-section">
        <h3>關於</h3>
        <p>紀錄開發專案時學到的技術、踩過的坑、一些想法。</p>
      </div>

      <div class="sidebar-section">
        <h3>最近文章</h3>
        <ul class="recent-posts">
          {recentPosts.map((post) => (
            <li>
              <a href={post.url}>{post.frontmatter.title}</a>
            </li>
          ))}
        </ul>
      </div>

      <div class="sidebar-section sidebar-meta">
        <p class="meta-timer">
          地球繞太陽一圈要 8760 小時
          <br />
          這網站活了 <span id="hours-alive">0</span> 小時
        </p>
        <p class="meta-visitor">
          不小心點進來的人
          <br />
          <img src="https://visitor-badge.laobi.icu/badge?page_id=jeffrey0117.evernote" alt="visitors" />
        </p>
      </div>

      <div class="sidebar-section">
        <h3>連結</h3>
        <ul class="sidebar-links">
          <li><a href="https://github.com/Jeffrey0117" target="_blank">GitHub</a></li>
        </ul>
      </div>
    </aside>
  </div>
</BaseLayout>

<script>
  // 網站開始日期（改成你的實際日期）
  const startDate = new Date('2026-01-13T00:00:00');
  const now = new Date();
  const hoursAlive = Math.floor((now.getTime() - startDate.getTime()) / (1000 * 60 * 60));
  document.getElementById('hours-alive').textContent = hoursAlive.toLocaleString();
</script>

<script define:vars={{ categories }}>
  const categoryBtns = document.querySelectorAll('.category-btn');
  const filterBtns = document.querySelectorAll('.filter-btn');
  const postItems = document.querySelectorAll('.post-item');
  const tagsToggle = document.querySelector('.tags-toggle');
  const allTagsDiv = document.querySelector('.all-tags');

  // 主分類過濾
  categoryBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const category = btn.getAttribute('data-category');

      categoryBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // 清除細項 tag 的 active
      filterBtns.forEach(b => b.classList.remove('active'));

      postItems.forEach(item => {
        if (category === '全部') {
          item.style.display = '';
        } else {
          const tags = JSON.parse(item.getAttribute('data-tags') || '[]');
          const categoryTags = categories[category] || [];
          const hasMatch = tags.some(tag => categoryTags.includes(tag));
          item.style.display = hasMatch ? '' : 'none';
        }
      });
    });
  });

  // 細項 tag 過濾
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const tag = btn.getAttribute('data-tag');

      // 清除主分類的 active，只保留「全部」
      categoryBtns.forEach(b => b.classList.remove('active'));
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      postItems.forEach(item => {
        const tags = JSON.parse(item.getAttribute('data-tags') || '[]');
        item.style.display = tags.includes(tag) ? '' : 'none';
      });
    });
  });

  // 展開/收合標籤
  tagsToggle.addEventListener('click', () => {
    allTagsDiv.classList.toggle('collapsed');
    const icon = tagsToggle.querySelector('.toggle-icon');
    icon.textContent = allTagsDiv.classList.contains('collapsed') ? '▼' : '▲';
  });
</script>

<style>
  .home-layout {
    display: grid;
    grid-template-columns: 1fr 200px;
    gap: var(--space-lg);
    align-items: start;
  }

  .main-content {
    min-width: 0;
  }

  .sidebar {
    position: sticky;
    top: 2rem;
  }

  @media (max-width: 900px) {
    .home-layout {
      grid-template-columns: 1fr;
    }
    .sidebar {
      display: none;
    }
  }

  /* 主分類 */
  .category-filter {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
  }

  .category-btn {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-secondary);
    background: transparent;
    border: 1px solid var(--bg-tertiary);
    padding: 0.4em 1em;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .category-btn:hover {
    border-color: var(--accent-light);
    color: var(--text-primary);
  }

  .category-btn.active {
    background: var(--text-primary);
    color: var(--bg-primary);
    border-color: var(--text-primary);
  }

  /* 底部標籤區 */
  .all-tags-section {
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--bg-tertiary);
  }

  .tags-toggle {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-muted);
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
  }

  .tags-toggle:hover {
    color: var(--text-secondary);
  }

  .toggle-icon {
    font-size: 0.6rem;
  }

  .all-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    transition: all 0.3s ease;
  }

  .all-tags.collapsed {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
  }

  .all-tags:not(.collapsed) {
    max-height: 500px;
    opacity: 1;
  }

  /* 側邊欄 */
  .sidebar {
    font-size: 0.85rem;
  }

  .sidebar-stats {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--bg-tertiary);
  }

  .sidebar-stats p {
    margin: 0;
    color: var(--text-muted);
    font-size: 0.8rem;
    line-height: 1.6;
  }

  .sidebar-stats .stats-joke {
    margin-top: var(--space-sm);
    font-size: 0.7rem;
    color: var(--text-muted);
    opacity: 0.5;
  }

  .sidebar-section {
    margin-bottom: var(--space-lg);
  }

  .sidebar-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .sidebar-meta p {
    margin-bottom: var(--space-md);
  }

  .sidebar-meta img {
    margin-top: var(--space-xs);
  }

  .sidebar-section h3 {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-sm);
  }

  .sidebar-section p {
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .recent-posts,
  .sidebar-links {
    list-style: none;
  }

  .recent-posts li,
  .sidebar-links li {
    margin-bottom: var(--space-xs);
  }

  .recent-posts a,
  .sidebar-links a {
    color: var(--text-secondary);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .recent-posts a:hover,
  .sidebar-links a:hover {
    color: var(--accent);
  }
</style>
