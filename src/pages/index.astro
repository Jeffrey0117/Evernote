---
import BaseLayout from '../layouts/BaseLayout.astro';

// 取得所有 markdown 文章
const posts = await Astro.glob('./posts/*.md');

// 按日期排序（新的在前），置頂文章優先
const sortedPosts = posts.sort((a, b) => {
  // 置頂優先
  if (a.frontmatter.pinned && !b.frontmatter.pinned) return -1;
  if (!a.frontmatter.pinned && b.frontmatter.pinned) return 1;
  // 再按日期排序
  return new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime();
});

// 主分類定義
const categories = {
  '全部': [],
  '技術': ['Electron', 'React', 'Python', 'Node.js', 'CSS', 'TypeScript', 'Astro', 'OpenCV', 'Tesseract.js', 'JSZip', 'AI', 'OCR', '前端', '設計系統'],
  '觀念': ['開發觀念', '專案管理', '寫作', '技術分享', 'Vibe Coding', '工作流程'],
  '專案': ['專案心得', '專案文件'],
  '工具': ['CLI', 'VSCode', '開發工具', 'DX', 'Windows', '自動化'],
};

// 收集所有 tags
const allTags = [...new Set(sortedPosts.flatMap(post => post.frontmatter.tags || []))];

const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  const datePart = date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).replace(/\//g, '.');
  const timePart = date.toLocaleTimeString('zh-TW', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  });
  return `${datePart} ${timePart}`;
};

// 取得文章摘要（description + 內文前 100 字）
const getExcerpt = (post: any) => {
  const desc = post.frontmatter.description || '';
  const content = post.rawContent?.() || '';
  // 移除 frontmatter、標題、markdown 語法
  const cleanContent = content
    .replace(/^---[\s\S]*?---/, '')       // frontmatter
    .replace(/^#+\s+.*/gm, '')            // 標題
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // [text](url) -> text
    .replace(/!\[([^\]]*)\]\([^)]+\)/g, '') // 圖片移除
    .replace(/`{3}[\s\S]*?`{3}/g, '')     // code block
    .replace(/`([^`]+)`/g, '$1')          // inline code
    .replace(/\*\*([^*]+)\*\*/g, '$1')    // **bold**
    .replace(/\*([^*]+)\*/g, '$1')        // *italic*
    .replace(/~~([^~]+)~~/g, '$1')        // ~~strikethrough~~
    .replace(/>\s+/g, '')                 // blockquote
    .replace(/[-*+]\s+/g, '')             // list items
    .replace(/\d+\.\s+/g, '')             // numbered list
    .replace(/\n+/g, ' ')
    .trim()
    .slice(0, 100);

  // 保留原本的 description，再加內文
  if (desc) {
    if (cleanContent) {
      return `${desc} — ${cleanContent}...`;
    }
    return desc;
  }
  return cleanContent ? `${cleanContent}...` : '';
};

// 分頁設定
const POSTS_PER_PAGE = 15;

// 最近 5 篇文章（給側邊欄用）
const recentPosts = sortedPosts.filter(p => !p.frontmatter.pinned).slice(0, 5);

// 統計
const totalPosts = sortedPosts.length;
const totalWords = sortedPosts.reduce((sum, post) => {
  const content = post.rawContent?.() || '';
  return sum + content.length;
}, 0);

// 荒謬比喻
const jokes = [
  `比太陽系的行星多 ${Math.round(totalWords / 8).toLocaleString()} 倍`,
  `大概要 ${Math.round(totalWords / 400 / 60 * 10) / 10} 小時才看得完`,
  `是你 ${Math.round(totalWords / 20000)} 天的呼吸次數`,
  `可以印 ${Math.round(totalWords / 500)} 張 A4 紙`,
];
const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
---

<BaseLayout title="Jeffrey0117 技術筆記">
  <div class="home-layout">
    <section class="main-content">
      <!-- 主分類 -->
      <div class="category-filter">
        {Object.keys(categories).map((cat) => (
          <button class={`category-btn ${cat === '全部' ? 'active' : ''}`} data-category={cat}>
            {cat}
          </button>
        ))}
      </div>

      <!-- 文章列表 -->
      <ul class="post-list">
        {sortedPosts.map((post) => (
          <li class="post-item" data-tags={JSON.stringify(post.frontmatter.tags || [])}>
            <time class="post-date" datetime={post.frontmatter.date}>
              {formatDate(post.frontmatter.date)}
            </time>
            <h2 class="post-title">
              {post.frontmatter.pinned && <span class="pinned-badge">置頂</span>}
              <a href={post.url}>{post.frontmatter.title}</a>
            </h2>
            <p class="post-excerpt">{getExcerpt(post)}</p>
            {post.frontmatter.tags && post.frontmatter.tags.length > 0 && (
              <div class="post-tags">
                {post.frontmatter.tags.map((tag: string) => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
            )}
          </li>
        ))}
      </ul>

      <!-- 分頁控制 -->
      <div class="pagination">
        <button class="page-btn" id="prev-page" disabled>← 上一頁</button>
        <span class="page-info">第 <span id="current-page">1</span> / <span id="total-pages">1</span> 頁</span>
        <button class="page-btn" id="next-page">下一頁 →</button>
      </div>

      <!-- 所有標籤（底部） -->
      <div class="all-tags-section">
        <button class="tags-toggle">
          <span>所有標籤</span>
          <span class="toggle-icon">▼</span>
        </button>
        <div class="all-tags collapsed">
          {allTags.map((tag) => (
            <button class="filter-btn" data-tag={tag}>{tag}</button>
          ))}
        </div>
      </div>
    </section>

    <!-- 側邊欄 -->
    <aside class="sidebar">
      <div class="sidebar-stats">
        <p>這裡有 {totalPosts} 篇文章</p>
        <p>共 {totalWords.toLocaleString()} 字</p>
        <p class="stats-joke">{randomJoke}</p>
      </div>

      <div class="sidebar-section">
        <h3>關於</h3>
        <p>紀錄開發專案時學到的技術、踩過的坑、一些想法。</p>
      </div>

      <div class="sidebar-section">
        <h3>最近文章</h3>
        <ul class="recent-posts">
          {recentPosts.map((post) => (
            <li>
              <a href={post.url}>{post.frontmatter.title}</a>
            </li>
          ))}
        </ul>
      </div>

      <div class="sidebar-section sidebar-meta">
        <p class="meta-timer">
          地球繞太陽一圈要 8760 小時
          <br />
          這網站活了 <span id="hours-alive">0</span> 小時
        </p>
        <p class="meta-visitor">
          <img src="https://visitor-badge.laobi.icu/badge?page_id=jeffrey0117.evernote&left_text=about" alt="visitors" /> souls lost here
        </p>
      </div>

      <div class="sidebar-section">
        <h3>連結</h3>
        <ul class="sidebar-links">
          <li><a href="https://github.com/Jeffrey0117" target="_blank">GitHub</a></li>
        </ul>
      </div>
    </aside>
  </div>
</BaseLayout>

<script>
  // 網站開始日期（改成你的實際日期）
  const startDate = new Date('2026-01-13T00:00:00');
  const now = new Date();
  const hoursAlive = Math.floor((now.getTime() - startDate.getTime()) / (1000 * 60 * 60));
  document.getElementById('hours-alive').textContent = hoursAlive.toLocaleString();
</script>

<script define:vars={{ categories, POSTS_PER_PAGE }}>
  const categoryBtns = document.querySelectorAll('.category-btn');
  const filterBtns = document.querySelectorAll('.filter-btn');
  const postItems = document.querySelectorAll('.post-item');
  const tagsToggle = document.querySelector('.tags-toggle');
  const allTagsDiv = document.querySelector('.all-tags');

  // 分頁元素
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  const currentPageSpan = document.getElementById('current-page');
  const totalPagesSpan = document.getElementById('total-pages');

  let currentPage = 1;
  let filteredPosts = [...postItems];

  // 取得符合過濾條件的文章
  function getFilteredPosts() {
    const activeCategory = document.querySelector('.category-btn.active');
    const activeTag = document.querySelector('.filter-btn.active');

    if (activeTag) {
      const tag = activeTag.getAttribute('data-tag');
      return [...postItems].filter(item => {
        const tags = JSON.parse(item.getAttribute('data-tags') || '[]');
        return tags.includes(tag);
      });
    }

    if (activeCategory) {
      const category = activeCategory.getAttribute('data-category');
      if (category === '全部') return [...postItems];
      const categoryTags = categories[category] || [];
      return [...postItems].filter(item => {
        const tags = JSON.parse(item.getAttribute('data-tags') || '[]');
        return tags.some(tag => categoryTags.includes(tag));
      });
    }

    return [...postItems];
  }

  // 更新分頁顯示
  function updatePagination() {
    filteredPosts = getFilteredPosts();
    const totalPages = Math.max(1, Math.ceil(filteredPosts.length / POSTS_PER_PAGE));

    // 確保當前頁不超過總頁數
    if (currentPage > totalPages) currentPage = totalPages;

    currentPageSpan.textContent = currentPage;
    totalPagesSpan.textContent = totalPages;

    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;

    // 先隱藏所有文章
    postItems.forEach(item => item.style.display = 'none');

    // 顯示當前頁的文章
    const start = (currentPage - 1) * POSTS_PER_PAGE;
    const end = start + POSTS_PER_PAGE;
    filteredPosts.slice(start, end).forEach(item => item.style.display = '');
  }

  // 主分類過濾
  categoryBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      categoryBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filterBtns.forEach(b => b.classList.remove('active'));
      currentPage = 1;
      updatePagination();
    });
  });

  // 細項 tag 過濾
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      categoryBtns.forEach(b => b.classList.remove('active'));
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentPage = 1;
      updatePagination();
    });
  });

  // 分頁按鈕
  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      updatePagination();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  nextBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
    if (currentPage < totalPages) {
      currentPage++;
      updatePagination();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  // 展開/收合標籤
  tagsToggle.addEventListener('click', () => {
    allTagsDiv.classList.toggle('collapsed');
    const icon = tagsToggle.querySelector('.toggle-icon');
    icon.textContent = allTagsDiv.classList.contains('collapsed') ? '▼' : '▲';
  });

  // 初始化分頁
  updatePagination();
</script>

<style>
  .home-layout {
    display: grid;
    grid-template-columns: 1fr 200px;
    gap: var(--space-lg);
    align-items: start;
  }

  .main-content {
    min-width: 0;
  }

  .sidebar {
    position: sticky;
    top: 2rem;
  }

  @media (max-width: 900px) {
    .home-layout {
      grid-template-columns: 1fr;
    }
    .sidebar {
      display: none;
    }
  }

  /* 主分類 */
  .category-filter {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
  }

  .category-btn {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-secondary);
    background: transparent;
    border: 1px solid var(--bg-tertiary);
    padding: 0.4em 1em;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .category-btn:hover {
    border-color: var(--accent-light);
    color: var(--text-primary);
  }

  .category-btn.active {
    background: var(--text-primary);
    color: var(--bg-primary);
    border-color: var(--text-primary);
  }

  /* 底部標籤區 */
  .all-tags-section {
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--bg-tertiary);
  }

  .tags-toggle {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-muted);
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
  }

  .tags-toggle:hover {
    color: var(--text-secondary);
  }

  .toggle-icon {
    font-size: 0.6rem;
  }

  .all-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    transition: all 0.3s ease;
  }

  .all-tags.collapsed {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
  }

  .all-tags:not(.collapsed) {
    max-height: 500px;
    opacity: 1;
  }

  /* 分頁 */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-md);
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--bg-tertiary);
  }

  .page-btn {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-secondary);
    background: transparent;
    border: 1px solid var(--bg-tertiary);
    padding: 0.5em 1em;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .page-btn:hover:not(:disabled) {
    border-color: var(--accent-light);
    color: var(--text-primary);
  }

  .page-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .page-info {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  /* 側邊欄 */
  .sidebar {
    font-size: 0.85rem;
  }

  .sidebar-stats {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--bg-tertiary);
  }

  .sidebar-stats p {
    margin: 0;
    color: var(--text-muted);
    font-size: 0.8rem;
    line-height: 1.6;
  }

  .sidebar-stats .stats-joke {
    margin-top: var(--space-sm);
    font-size: 0.7rem;
    color: var(--text-muted);
    opacity: 0.5;
  }

  .sidebar-section {
    margin-bottom: var(--space-lg);
  }

  .sidebar-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .sidebar-meta p {
    margin-bottom: var(--space-md);
  }

  .sidebar-meta img {
    vertical-align: middle;
    margin-right: 0.3em;
  }

  .sidebar-section h3 {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-sm);
  }

  .sidebar-section p {
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .recent-posts,
  .sidebar-links {
    list-style: none;
  }

  .recent-posts li,
  .sidebar-links li {
    margin-bottom: var(--space-xs);
  }

  .recent-posts a,
  .sidebar-links a {
    color: var(--text-secondary);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .recent-posts a:hover,
  .sidebar-links a:hover {
    color: var(--accent);
  }
</style>
