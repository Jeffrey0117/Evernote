---
layout: ../../layouts/PostLayout.astro
title: 當一個用戶同時屬於三個租戶
date: 2026-01-13T12:16
description: 設計三層權限模型，解決用戶同時屬於多個租戶的權限管理問題
tags:
  - Multi-Tenant
  - 權限設計
  - PostgreSQL
  - Supabase
---

「這個用戶是 admin，所以他可以看到所有課程。」

這是我一開始的權限設計。

users 表加一個 role 欄位，值是 `admin`、`member`、`guest` 之一。
API 裡面判斷 `if (user.role === 'admin')` 就放行。

簡單、直覺、快速。

然後問題來了。

---

## 先講一下什麼是 Multi-Tenant

如果你沒碰過這個詞，可以想像成「一個系統裡面有很多房東」。

像 Notion、Slack、Shopify 這些 SaaS 產品，每個公司或團隊都有自己的「空間」。
Notion 裡面你的 workspace 跟我的 workspace 是分開的，你看不到我的筆記，我也看不到你的。

這個「空間」就是租戶（Tenant）。

Multi-Tenant 就是「一套系統服務多個租戶」。
所有租戶共用同一套程式碼、同一個資料庫，但資料是隔離的。

我在做的是線上課程平台。
每個講師有自己的「學院」——自己的課程、自己的學生、自己的訂單。
這些學院就是租戶。

好，背景講完了。

---

## 義大利麵是怎麼長出來的

講師 Jeff 在自己的租戶是 admin，他可以管理課程、查看訂單、設定價格。
沒問題。

但 Jeff 同時也是講師 Alice 那邊的學生——他買了 Alice 的課。

這時候 Jeff 的 role 是什麼？

`admin`？
那他不就可以看到 Alice 的後台了？

`member`？
那他自己的租戶怎麼管理？

我試著加一個 `current_tenant_id` 欄位來追蹤「用戶目前在哪個租戶」，然後根據這個切換權限。

結果 code 變成這樣：

```typescript
function canEditCourse(user, course) {
  if (user.role === 'admin' && user.current_tenant_id === course.tenant_id) {
    return true;
  }
  if (user.role === 'super_admin') {
    return true;
  }
  if (user.id === course.creator_id) {
    return true;
  }
  // 還有十幾個 if...
}
```

每次加新功能，就要回來改這個函數。
每次有 bug，就要花半小時 debug 這坨義大利麵。

**義大利麵不是一開始就是義大利麵的。**

它是這樣長出來的：

1. 一開始只有一個 `if`，很乾淨
2. 需求來了，加一個 `if`
3. 邊界情況，再加一個 `if`
4. 例外處理，又加一個 `if`
5. 半年後回頭看，已經認不出來了

問題出在哪？

**我把「這個人是誰」跟「這個人在這裡能幹嘛」混在一起了。**

Jeff 是 Jeff，這件事不會變。
但 Jeff 在自己學院是老闆，在 Alice 學院是學生——這是「關係」，不是「身份」。

我意識到根本問題：**權限不應該綁在 user 身上，應該綁在「user 和 tenant 的關係」上。**

---

## 用門禁系統理解三層權限

踩完坑之後，我重新設計了權限架構。
分成三層，用大樓門禁來比喻：

**第一層：你是不是住戶？**

大樓門口有警衛。
他不管你住哪一戶，只管你是不是這棟大樓的人。
有門禁卡就放行，沒有就請回。

這是「認證」——你是誰？你有沒有登入？
[Supabase](https://supabase.com/) Auth 幫我處理這層。

**第二層：你住哪一戶？你是什麼身份？**

進了大樓，你要去哪？
你是 12 樓 A 戶的屋主，還是 5 樓 B 戶的訪客？
屋主可以進自己家，訪客要有人帶。

這是「租戶歸屬」——你屬於哪些租戶？在每個租戶裡的角色是什麼？
**這是多租戶權限的核心。**

**第三層：你能動這個東西嗎？**

進了家門，你能動什麼？
屋主可以換家具、丟垃圾。
訪客只能坐著喝茶，不能翻抽屜。

這是「資源權限」——你對這個特定的東西有什麼權限？

三層分開，各司其職：

| 層級 | 問的問題 | 處理者 |
|------|----------|--------|
| 認證 | 你是誰？ | Supabase Auth |
| 租戶歸屬 | 你跟這個租戶什麼關係？ | user_tenant_access 表 |
| 資源權限 | 你能動這個東西嗎？ | 商業邏輯判斷 |

這樣拆開，每一層只需要回答一個問題。
不用在一個 function 裡面塞十幾個 `if`。

---

## 那張關鍵的中間表

三層架構的核心在第二層。
而第二層的實作，就是一張中間表。

### 為什麼需要中間表？

原本我的設計是這樣：

- users 表有一個 role 欄位
- users 表有一個 tenant_id 欄位

一個用戶，一個角色，一個租戶。
簡單，但錯了。

現實是：**一個用戶可以同時屬於多個租戶，而且在每個租戶的角色不同。**

這是典型的「多對多關係」。
解法就是加一張中間表，記錄「誰」和「哪個租戶」的「什麼關係」。

### user_tenant_access 表

```sql
CREATE TABLE user_tenant_access (
  user_id UUID NOT NULL,   -- 誰
  tenant_id UUID NOT NULL, -- 哪個租戶
  role TEXT NOT NULL,      -- 什麼關係

  UNIQUE(user_id, tenant_id) -- 同一個人在同一個租戶只有一種角色
);
```

就這三個欄位，核心概念很簡單。

現在 Jeff 的權限變成這樣：

| user_id | tenant_id | role |
|---------|-----------|------|
| jeff | jeff_academy | owner |
| jeff | alice_academy | member |
| jeff | bob_academy | admin |

一個用戶，三個租戶，三種不同的角色。
不用再糾結「Jeff 到底是什麼 role」，因為要看「Jeff 在哪裡」。

### 為什麼要加 UNIQUE 約束？

`UNIQUE(user_id, tenant_id)` 這行很重要。

它確保同一個人在同一個租戶只會有一筆記錄。
不然可能會出現：

| user_id | tenant_id | role |
|---------|-----------|------|
| jeff | jeff_academy | owner |
| jeff | jeff_academy | member |

Jeff 在自己學院同時是 owner 又是 member？
這種資料不應該存在。
加了 UNIQUE，資料庫會幫你擋掉。

---

## 角色不要設計太多

有了中間表，接下來要決定：role 有哪些值？

我只用三個：

| 角色 | 說明 | 能幹嘛 |
|------|------|--------|
| **owner** | 租戶擁有者 | 什麼都能做，包含刪除整個租戶 |
| **admin** | 管理員 | 管理日常營運，但不能動租戶本身 |
| **member** | 一般成員 | 只能用，不能管 |

三個就夠了。

很多人會想：要不要加個 super_admin？要不要分 editor 和 viewer？要不要有 moderator？

不要。

角色越多，權限判斷越複雜，維護成本越高。
真的有需要再加，不要預先設計。

### 為什麼要分 owner 和 admin？

這是我被教訓過才學到的。

我聽過一個案例：某個 SaaS 產品的創辦人，請了一個人幫忙管理後台，給他 admin 權限。
結果那個人把創辦人的帳號權限降級了，創辦人反而被鎖在門外。

聽起來很扯，但技術上完全可能發生。

如果 admin 可以管理其他 admin，那 admin 就可以把 owner 踢掉。
這不是 bug，是設計問題。

所以我把 owner 獨立出來：

**owner 能做、admin 不能做的事：**
- 刪除整個租戶
- 轉移擁有權給別人
- 修改計費資訊
- 新增或移除其他 admin

admin 可以幫你管課程、管訂單、管學生。
但 admin 動不了你的根本——帳號還是你的。

這就像公司的股東和總經理。
總經理權力很大，但他不能把股東踢出公司。

---

## 第三層：這個人能動這個東西嗎

前兩層處理完「你是誰」和「你跟這個租戶什麼關係」。
第三層要回答更具體的問題：**你能對這個特定的東西做什麼？**

舉例：「這個用戶可以看這堂課嗎？」

光知道他是 member 還不夠，還要看：

1. 這堂課是公開的還是付費的？
2. 如果是付費的，他有沒有買？
3. 如果他是 admin，那就不用管有沒有買

判斷流程：

```
用戶要看課程 A
    ↓
課程 A 屬於租戶 X
    ↓
用戶在租戶 X 的角色是什麼？
    ↓
┌─────────────────────────────────────────┐
│ owner / admin → 直接放行                │
│ member → 檢查課程是否公開，或是否已購買  │
│ 不屬於租戶 X → 拒絕                     │
└─────────────────────────────────────────┘
```

這個流程很清楚，每一步都只問一個問題。
比起原本那坨義大利麵，好維護太多了。

---

## 兩層防護：應用層和資料庫層

到這裡，權限判斷都在應用層（TypeScript）做。
但這樣夠嗎？

不夠。

如果你的程式碼有 bug，權限檢查被繞過了怎麼辦？
如果新來的工程師忘記加權限檢查怎麼辦？

所以要在資料庫層再加一道防線——[RLS（Row Level Security）](/posts/supabase-rls-multi-tenant)。

### 兩層各負責什麼？

| 層級 | 負責 | 失敗的後果 |
|------|------|-----------|
| 應用層 | 商業邏輯判斷、友善錯誤訊息 | 用戶體驗差 |
| 資料庫層 | 資料隔離的最後防線 | 資料外洩 |

應用層可以給用戶清楚的錯誤訊息：「您沒有權限編輯這堂課」。
資料庫層不管這些，它只管一件事：**就算程式出 bug，資料也不會洩漏到其他租戶。**

這叫「深度防禦」。
一層出問題，還有另一層擋著。

### RLS 怎麼用 user_tenant_access？

RLS 政策可以直接查 user_tenant_access 表：

```sql
-- 只能看到自己所屬租戶的課程
CREATE POLICY "courses_select" ON courses FOR SELECT USING (
  tenant_id IN (
    SELECT tenant_id FROM user_tenant_access WHERE user_id = auth.uid()
  )
);
```

這樣就算應用層忘記檢查，資料庫也會自動過濾。
用戶只能看到他有權限看的資料。

RLS 的詳細設計我在[另一篇](/posts/supabase-rls-multi-tenant)講過，這裡不展開。

---

## 幾個實務上要注意的事

概念講完了，實作的時候有幾個細節要注意。

### 建立租戶時要自動設 owner

用戶建立新租戶時，一定要同時在 user_tenant_access 建一筆記錄，role 是 owner。

這可以在應用層做，也可以用資料庫 trigger 自動處理。
重點是：**不能漏掉這一步**，不然會出現沒有 owner 的孤兒租戶。

### 移除用戶時要檢查是不是 owner

如果有人要把 owner 從租戶移除，要擋掉。
owner 要離開，必須先轉移擁有權給別人。

不然租戶就變成無主之地了。

### 用戶可以屬於多個租戶，需要切換介面

用戶登入後，要有地方讓他切換目前在操作哪個租戶。
通常會做一個下拉選單，列出他所有的租戶和對應角色。

切換後，導向那個租戶的後台。
路由設計可以看[這篇](/posts/nextjs-multi-tenant-routing)。

---

繞了一大圈，核心就一句話：**權限不要綁在 user 上，要綁在「user 和 tenant 的關係」上。**

搞懂這件事之後，三層架構就是自然的結論：

1. **認證**：你是誰？（Supabase Auth 處理）
2. **租戶歸屬**：你跟這個租戶什麼關係？（user_tenant_access 表）
3. **資源權限**：你能動這個東西嗎？（商業邏輯判斷）

`user_tenant_access` 這張中間表是整個架構的核心。
一個用戶可以屬於多個租戶，每個租戶有不同角色。
不用再煩惱「Jeff 到底是什麼 role」，因為要看他在哪裡。

角色也不用設計太多，owner、admin、member 三個就夠。
owner 和 admin 要分開，不然可能被自己請的人踢出去。

最後再配合 RLS 做深度防禦——應用層判斷商業邏輯，資料庫層防止資料洩漏。
兩層都過才能動資料，一層出問題還有另一層擋著。

下一篇會講**租戶品牌自訂**——怎麼讓每個租戶有自己的 Logo、顏色、Favicon。
這是 SaaS 產品很重要的功能，讓客戶覺得這是「他們的」平台，不是借用別人的。

