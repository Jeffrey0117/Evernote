---
layout: ../../layouts/PostLayout.astro
title: 從自架課程網站到 SaaS 平台，我才搞懂什麼是 Multi-Tenant
date: 2026-01-13T12:13
description: 搞懂多租戶架構的核心概念，以及三種資料隔離策略怎麼選
tags:
  - Multi-Tenant
  - SaaS
  - 架構設計
  - PostgreSQL
---

一開始只是想做一個簡單的網頁，放我自己的課程。

用戶註冊、買課、看影片，功能很單純。

做完之後覺得還不錯，就想說加個後台管理、加個金流串接、加個進度追蹤。

功能越疊越多，慢慢變成一個完整的課程平台。

然後有朋友問：「欸，這個可以給我用嗎？我也想賣課。」

我說可以啊，幫你開個帳號。

結果他又問：「可是我想要有自己的網址、自己的品牌，學生進來看到的是我的 Logo，不是你的。」

我愣了一下。

這不就變成要做 [Teachable](https://teachable.com/)、[Thinkific](https://www.thinkific.com/) 那種東西嗎？

一個平台，N 個講師，每個講師有自己的網址、自己的品牌、自己的學生。

學生 A 在講師甲那邊買的課，不會出現在講師乙的後台。

我去 Google 才發現，這種架構有個專有名詞——**Multi-Tenant（多租戶）**。

---

## 你每天都在用，只是沒發現

Multi-Tenant 聽起來像什麼很厲害的架構名詞，但其實你每天都在用。

[Notion](https://www.notion.so/) 上你有好幾個 Workspace，每個 Workspace 的頁面彼此看不到。

[Slack](https://slack.com/) 上你可能加入好幾間公司的頻道，每間公司的訊息彼此隔開。

[Shopify](https://www.shopify.com/) 上每個商家都有自己的網址、自己的後台、自己的商品。

這些產品的共同點是什麼？

**一套程式碼，服務上百萬個「租戶」。**

Notion 不會幫每個 Workspace 開一台 server。

Shopify 不會幫每個商家部署一套獨立的程式碼。

他們都是在同一套系統裡，用某種方式把資料隔開。

這就是 Multi-Tenant 的核心概念——多個租戶共享同一套系統，但彼此的資料完全隔離。

---

## 公寓大樓的比喻

理解 Multi-Tenant 最好的方式，是把它想成一棟公寓大樓。

大樓本身就是你的 SaaS 平台。

每一戶住戶，就是一個租戶——可能是講師、公司、團隊，whatever。

住戶的房間就是他們的資料。

而電梯、水電、管線這些公共設施，就是共用的程式碼和基礎設施。

每個住戶覺得自己住在獨立的家，但其實大家共用同一棟大樓。

住戶 A 看不到住戶 B 家裡的東西——這就是「隔離」。

**對應到軟體，就是每個租戶覺得自己在用一個專屬的系統，但其實背後跑的是同一套 code。**

這個比喻會貫穿整篇文章。

等等講到三種資料隔離策略的時候，你會看到：有些做法像是每戶獨立門牌（但共用大樓結構），有些像是整棟樓只用一扇門進出但裡面再隔間，差別很大。

---

## 不就是加個 user_id 嗎？

我一開始也搞混這件事。

做一般的應用程式，想要區分不同用戶的資料，就是每筆資料加個 `user_id`，查詢的時候 `WHERE user_id = ?`。

這樣用戶 A 就不會看到用戶 B 的資料。

很簡單對吧？那 Multi-Tenant 複雜在哪？

差別在於**層級不一樣**。

一般的系統是「一個系統，多個用戶」，大家平等，用戶之間沒有從屬關係。

但 Multi-Tenant 是「一個系統裡面有多個『小系統』，每個小系統裡面又有自己的用戶」。

用課程平台的例子來說：

講師 Jeff 有他自己的網站，底下有學生 A 和學生 B。

講師 Alice 也有她自己的網站，底下有學生 C 和學生 D。

有趣的是，學生 D 可能同時在 Jeff 和 Alice 那邊買課。

在 Jeff 那邊他是學生 D，在 Alice 那邊他也是學生 D，但這兩個身份是分開的。

購買記錄、學習進度、付款資訊，全部隔開。

Jeff 在後台看不到學生 D 在 Alice 那邊買了什麼。

Alice 也看不到學生 D 在 Jeff 那邊的學習進度。

**這才是 Multi-Tenant 的核心：隔離的單位不是「用戶」，而是「租戶」。**

回到公寓大樓的比喻：住戶裡面可能有爸媽、小孩、阿公阿嬤，但隔離的單位是「住戶」，不是「個人」。

搞懂這個概念之後，下一個問題自然就來了：資料到底要怎麼隔離？

---

## 三種隔離策略

決定做 Multi-Tenant 之後，第一個問題是：**資料怎麼隔離？**

這裡有三種主流做法，各有適合的場景。

先講結論，然後再一個一個解釋。

| 策略 | 一句話描述 | 適合什麼情況 |
|------|----------|-------------|
| Database per Tenant | 每個租戶獨立一個資料庫 | 客戶是大企業、金融醫療、願意付大錢 |
| Schema per Tenant | 同一個資料庫，每個租戶獨立 Schema | 中型 SaaS、租戶幾十到幾百個、需要一定隔離 |
| Row-Level | 同一張表，用 tenant_id 區分 | 新創、快速迭代、租戶數量多但單一租戶資料量不大 |

### Database per Tenant：每戶一棟獨立透天

這是最徹底的隔離方式。

每個租戶都有自己獨立的資料庫，完全分開。

用公寓大樓的比喻來說，這不是公寓了，是每戶都有一棟獨立的透天厝，只是蓋在同一個社區裡。

**什麼情況該用這種？**

當你的客戶是大企業，或者是金融、醫療這種資安要求極高的產業。

這些客戶通常會明確要求「我的資料不能跟別人放在一起」，而且他們願意為此付高價。

你也願意為了這筆錢，花人力去維護。

**代價是什麼？**

管理地獄。

100 個租戶就是 100 個資料庫。

改個資料表結構，要跑 100 次 migration。

資料庫連線池也要開 100 組。

如果你是小團隊想快速迭代，這種做法會讓你累死。

### Schema per Tenant：同一棟大樓，每戶獨立門牌

這是介於中間的做法。

所有租戶共用同一個資料庫，但每個租戶有自己的 Schema。

Schema 你可以想成是資料庫裡面的「命名空間」或「資料夾」。

每個 Schema 裡面都有完整的資料表結構（courses、orders、users），但彼此不會互相干擾。

用公寓大樓的比喻，這就像同一棟大樓裡面的不同樓層。

大家共用電梯和大門，但每層樓有自己的門牌、自己的房間配置。

**什麼情況該用這種？**

你的租戶數量在幾十到幾百之間，需要一定程度的資料隔離，但又不想為每個租戶維護一個獨立資料庫。

比如說，你的客戶是中小企業，他們在意資料隔離，但不像金融業那麼偏執。

**代價是什麼？**

Schema 太多會影響效能。

而且這招主要是 [PostgreSQL](https://www.postgresql.org/) 的特色，[MySQL](https://www.mysql.com/) 沒有這種概念（MySQL 的 schema 就是 database）。

如果你用的是 MySQL，這條路基本上走不通。

### Row-Level：同一間大通鋪，用布簾隔開

這是最簡單、最常見的做法。

所有租戶的資料都放在同一張表裡面，用一個 `tenant_id` 欄位來區分誰是誰的。

查詢的時候加上 `WHERE tenant_id = ?`，就只會撈到該租戶的資料。

用公寓大樓的比喻，這像是一間大通鋪，大家睡在同一個空間，但用布簾隔開各自的床位。

物理上沒有隔開，但邏輯上是分開的。

**什麼情況該用這種？**

你是新創團隊，想快速把東西做出來。

你的租戶數量可能很多（幾千、幾萬個都行），但單一租戶的資料量不會太誇張。

你不需要對客戶承諾「物理隔離」，客戶也不會要求這個。

**代價是什麼？**

隔離是邏輯層面的，不是物理層面的。

這代表如果你的 code 寫錯——忘記加 `WHERE tenant_id = ?`——就會把別人的資料也撈出來。

這是最大的風險，也是後面會講到的 RLS（Row-Level Security）要解決的問題。

---

## 我選哪個？

我選 Row-Level。

原因很實際。

第一，[Supabase](https://supabase.com/) 免費方案只有一個資料庫，根本開不了多個。

不是我不想用更隔離的方案，是免費仔沒得選。

第二，我的租戶數量不會太多，大概幾十到幾百個講師，不需要那麼強的隔離。

第三，也是最重要的——開發速度最快。

我只是想趕快把東西做出來驗證想法，不是在做什麼金融系統。

實作上就是每張表都加一個 `tenant_id` 欄位，然後記得在每次查詢的時候加上 `WHERE tenant_id = ?`。

概念上就這麼簡單。

但這只是開始。

選了 Row-Level 之後，接下來還有一堆問題要解決：

- **查詢忘記加 tenant_id 怎麼辦？** — 這是最大的風險，後面會講 RLS（Row-Level Security）怎麼幫你擋
- **網址怎麼區分不同租戶？** — jeff.myplatform.com 和 alice.myplatform.com 怎麼導到各自的資料
- **權限怎麼設計？** — 同一個人可能同時是講師 A 的學生，又是講師 B 的助教
- **每個租戶要有自己的品牌** — Logo、主題色、客製化設定怎麼存

這些我會在後續的文章一個一個講。

---

## Row-Level 的代價

講完為什麼選 Row-Level，也要講它的代價。

沒有完美的方案，每個選擇都有 trade-off。

### 效能天花板

所有租戶共用一個資料庫，資料量大了會變慢。

如果有一個租戶突然爆量——比如某個講師爆紅，學生從幾百人變成幾十萬人——整個資料庫都會被拖慢。

到時候你得把這個租戶獨立出去，這會是一番大工程。

但老實說，這是「好問題」。

真的有租戶能成長到拖慢整個資料庫，代表你的產品成功了，到時候再來煩惱也不遲。

### 隔離不夠徹底

Row-Level 是邏輯隔離，不是物理隔離。

如果你的客戶是金融業、醫療業，他們通常會明確要求「我的資料要放在獨立的資料庫裡」。

這種客戶 Row-Level 滿足不了。

但如果你的客戶是一般的中小企業或個人講師，他們通常不會在意這個。

### 心智負擔

這是最實際的代價。

寫每一行 code 都要問自己：這個查詢有沒有加 `tenant_id`？這個 API 有沒有檢查租戶權限？

漏掉一次，就可能把別人的資料撈出來。

習慣之後還好，但前幾個月會很痛苦。

好消息是，這個問題有解——RLS（Row-Level Security）可以讓資料庫自動幫你擋，就算 code 寫錯也不會漏資料。

這是下一篇要講的重點。

---

搞懂 Multi-Tenant 之後，我終於理解為什麼 [Notion](https://www.notion.so/)、[Shopify](https://www.shopify.com/) 這些 SaaS 平台可以一套 code 服務這麼多客戶。

核心就是把「租戶」當成隔離的單位，而不是「用戶」。

三種隔離策略各有適合的場景：

- 客戶是大企業、願意付大錢 → Database per Tenant
- 中型 SaaS、需要一定隔離 → Schema per Tenant
- 新創團隊、快速迭代 → Row-Level

對我這種想快速把東西做出來的人來說，Row-Level 是最實際的選擇。

下一篇會講 [Supabase](https://supabase.com/) 的 RLS（Row-Level Security），怎麼讓資料庫自動幫你擋住跨租戶的查詢。

就算 code 寫錯也不會漏資料，這才是真正的安全網。
